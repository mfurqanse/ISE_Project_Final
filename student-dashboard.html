<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - University Portal</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/responsive.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar student-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
                        <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
                    </svg>
                    <span>Student Portal</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="student-dashboard.html" class="nav-item active">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span>Dashboard</span>
                </a>
                <a href="view-attendance.html" class="nav-item">
                    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span>View Attendance</span>
                </a>
                <a href="view-results.html" class="nav-item">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>View Results</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-logout" onclick="logout()">
                    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1>Student Dashboard</h1>
                    <p class="subtitle">Welcome back, <span id="student-name">Student</span></p>
                </div>
                <div class="header-actions">
                    <div class="user-profile">
                        <div class="avatar student-bg">S</div>
                        <span id="user-email"></span>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Student Info Card -->
                <div class="info-card">
                    <div class="info-header">
                        <h3>Student Information</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Student ID:</span>
                            <span class="info-value" id="student-id">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Program:</span>
                            <span class="info-value" id="student-program">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Enrollment Year:</span>
                            <span class="info-value" id="enrollment-year">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Current Semester:</span>
                            <span class="info-value">Fall 2024</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon student-bg">
                            <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                        </div>
                        <div class="stat-details">
                            <p class="stat-label">Enrolled Courses</p>
                            <h3 class="stat-value" id="enrolled-courses">0</h3>
                            <p class="stat-change">This semester</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon admin-bg">
                            <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        </div>
                        <div class="stat-details">
                            <p class="stat-label">Overall Attendance</p>
                            <h3 class="stat-value" id="overall-attendance">0%</h3>
                            <p class="stat-change" id="attendance-status">-</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon teacher-bg">
                            <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </div>
                        <div class="stat-details">
                            <p class="stat-label">Average Grade</p>
                            <h3 class="stat-value" id="average-grade">-</h3>
                            <p class="stat-change">Across all courses</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon student-bg">
                            <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                        </div>
                        <div class="stat-details">
                            <p class="stat-label">Total Credits</p>
                            <h3 class="stat-value" id="total-credits">0</h3>
                            <p class="stat-change">Enrolled credits</p>
                        </div>
                    </div>
                </div>

                <!-- Enrolled Courses & Performance -->
                <div class="content-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>My Courses</h3>
                        </div>
                        <div class="card-body">
                            <div id="student-courses" class="courses-list"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Recent Assessments</h3>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Assessment</th>
                                        <th>Marks</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-assessments">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../data/mock-data.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/attendance.js"></script>
    <script src="../js/gradeCalculator.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('student');
            loadStudentDashboard();
        });

        function loadStudentDashboard() {
            const user = getCurrentUser();
            if (!user) return;

            const data = loadMockData();
            const student = data.students.find(s => s.id === user.id);
            
            if (student) {
                document.getElementById('student-name').textContent = student.firstName + ' ' + student.lastName;
                document.getElementById('user-email').textContent = student.email;
                document.getElementById('student-id').textContent = student.studentId;
                document.getElementById('student-program').textContent = student.program;
                document.getElementById('enrollment-year').textContent = student.enrollmentYear;
            }

            // Get student enrollments
            const enrollments = data.enrollments.filter(e => e.studentId === user.id);
            document.getElementById('enrolled-courses').textContent = enrollments.length;

            // Calculate total credits
            let totalCredits = 0;
            enrollments.forEach(enrollment => {
                const course = data.courses.find(c => c.id === enrollment.courseId);
                if (course) totalCredits += course.credits;
            });
            document.getElementById('total-credits').textContent = totalCredits;

            // Calculate attendance
            const studentAttendance = data.attendance.filter(a => a.studentId === user.id);
            const presentCount = studentAttendance.filter(a => a.status === 'present').length;
            const attendancePercentage = studentAttendance.length > 0 
                ? Math.round((presentCount / studentAttendance.length) * 100) 
                : 0;
            document.getElementById('overall-attendance').textContent = attendancePercentage + '%';
            
            const attendanceStatus = document.getElementById('attendance-status');
            if (attendancePercentage >= 75) {
                attendanceStatus.textContent = 'Good standing';
                attendanceStatus.className = 'stat-change positive';
            } else {
                attendanceStatus.textContent = 'Below requirement';
                attendanceStatus.className = 'stat-change negative';
            }

            // Calculate average grade
            const studentResults = data.results.filter(r => r.studentId === user.id);
            if (studentResults.length > 0) {
                let totalPercentage = 0;
                studentResults.forEach(result => {
                    const assessment = data.assessments.find(a => a.id === result.assessmentId);
                    if (assessment) {
                        const percentage = (result.marksObtained / assessment.maxMarks) * 100;
                        totalPercentage += percentage;
                    }
                });
                const avgGrade = Math.round(totalPercentage / studentResults.length);
                document.getElementById('average-grade').textContent = avgGrade + '%';
            } else {
                document.getElementById('average-grade').textContent = 'N/A';
            }

            // Display courses
            displayStudentCourses(enrollments, data);
            displayRecentAssessments(user.id, data);
        }

        function displayStudentCourses(enrollments, data) {
            const coursesList = document.getElementById('student-courses');
            coursesList.innerHTML = '';

            enrollments.forEach(enrollment => {
                const course = data.courses.find(c => c.id === enrollment.courseId);
                const teacher = data.teachers.find(t => t.id === course.teacherId);
                
                if (course) {
                    const courseCard = document.createElement('div');
                    courseCard.className = 'course-card';
                    courseCard.innerHTML = `
                        <div class="course-header">
                            <h4>${course.code} - ${course.name}</h4>
                            <span class="badge badge-success">${course.credits} Credits</span>
                        </div>
                        <p class="course-description">${course.description}</p>
                        <div class="course-footer">
                            <span>Instructor: ${teacher ? teacher.firstName + ' ' + teacher.lastName : 'TBA'}</span>
                            <span>${course.semester} ${course.academicYear}</span>
                        </div>
                    `;
                    coursesList.appendChild(courseCard);
                }
            });
        }

        function displayRecentAssessments(studentId, data) {
            const tbody = document.getElementById('recent-assessments');
            tbody.innerHTML = '';

            const studentResults = data.results.filter(r => r.studentId === studentId).slice(0, 5);
            
            if (studentResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No assessments yet</td></tr>';
                return;
            }

            studentResults.forEach(result => {
                const assessment = data.assessments.find(a => a.id === result.assessmentId);
                const course = data.courses.find(c => c.id === assessment.courseId);
                const percentage = (result.marksObtained / assessment.maxMarks) * 100;
                const grade = getLetterGrade(percentage);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${course.code}</td>
                    <td>${assessment.name}</td>
                    <td>${result.marksObtained}/${assessment.maxMarks}</td>
                    <td><span class="grade-badge grade-${grade[0]}">${grade}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = '../index.html';
            }
        }
    </script>
</body>
</html>
